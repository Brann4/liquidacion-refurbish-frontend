<p-card>
    <div class="px-4">
        <div class="flex justify-between">
            <p-button label="Volver" icon="pi pi-arrow-left" severity="secondary" (onClick)="goBack()"></p-button>
            <p-button
                label="Importar Liquidaciones"
                [disabled]="postventaDetalleStore.entitiesPreview().length > 0 && !postventaDetalleStore.isLoadingPostventa()"
                icon="pi pi-file-import"
                severity="primary"
                [raised]="true"
                size="large"
                (onClick)="handleToggleImport()"
            ></p-button>
        </div>

        @if (!postventaDetalleStore.liquidacionPostventa() && postventaDetalleStore.isLoadingPostventa()) {
            <div class="flex justify-center items-center">
                <p-progressSpinner class="w-10 h-10" strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
            </div>
        } @else if (postventaDetalleStore.contrata()) {
            <p-toolbar class="my-6 flex items-center">
                <ng-template pTemplate="start">
                    <div class="flex items-center justify-center">
                        <p class="text-4xl font-bold">
                            Contrata: <span class="text-4xl text-primary">{{ postventaDetalleStore.contrata()?.razonSocial }}</span>
                        </p>
                    </div>
                </ng-template>

                <ng-template pTemplate="end">
                    <div class="flex items-center justify-center gap-1">
                        <p-tag [value]="getEstadoLiquidacionLabel()" [severity]="getEstadoLiquidacionSeverity()" />
                        <p-tag [value]="formatFechaIngreso(postventaDetalleStore.liquidacionPostventa()?.fechaIngreso)" icon="pi pi-calendar"
                               severity="secondary" />
                    </div>
                </ng-template>
            </p-toolbar>
            @if (!showImportDialog() && postventaDetalleStore.isSubmitting()) {
                <div class="flex justify-center items-center">
                    <p-progressSpinner></p-progressSpinner>
                </div>
            }

            @if (showImportDialog()) {
                <div class="border-1 border-dashed border-primary p-4 rounded-lg mt-4">
                    <div class="flex justify-center mb-4">
                        <div class="bounce animation-iteration-infinite animation-duration-2000">
                            <a (click)="downloadExcelTemplate()" class="text-primary hover:underline cursor-pointer flex items-center gap-2 p-2">
                                <i class="pi pi-file-excel text-lg"></i>
                                <span class="font-semibold">Descargar plantilla haciendo click aqui</span>
                            </a>
                        </div>
                    </div>

                    <p-fileUpload
                        #fileUploader
                        name="file"
                        mode="advanced"
                        [multiple]="false"
                        accept=".xlsx,.xls"
                        invalidFileTypeMessageSummary="Tipo de archivo no válido."
                        invalidFileTypeMessageDetail="Solo se permiten archivos Excel (.xlsx, .xls)."
                        [maxFileSize]="maxFileSizeInBytes"
                        [showCancelButton]="false"
                        [showUploadButton]="false"
                        chooseLabel="Seleccionar archivo"
                        [customUpload]="true"
                        (uploadHandler)="handleUploadFile($event)"
                    >
                        <ng-template pTemplate="toolbar">
                            <div class="p-fileupload-buttonbar p-2 flex justify-between items-center gap-2">
                                <div class="flex gap-2">
                                    <p-button label="Eliminar" icon="pi pi-times" severity="danger" [outlined]="true" (onClick)="fileUploader.clear()" [disabled]="fileUploader.files.length === 0 || postventaDetalleStore.isSubmitting()"> </p-button>

                                    <p-button
                                        label="Procesar"
                                        icon="pi pi-upload"
                                        severity="info"
                                        (onClick)="fileUploader.upload()"
                                        [disabled]="fileUploader.files.length === 0 || postventaDetalleStore.isLoadingDataPreview()"
                                        [loading]="postventaDetalleStore.isLoadingDataPreview()"
                                    >
                                    </p-button>
                                </div>
                            </div>
                        </ng-template>

                        <ng-template pTemplate="empty">
                            <div class="flex items-center justify-center flex-col">
                                <i class="pi pi-cloud-upload !border-1 !rounded-full !p-8 !text-4xl !text-muted-color mb-2"></i>
                                <p class="mt-2 !text-muted-color">Arrastra y suelta el archivo aquí para procesarlo.</p>
                            </div>
                        </ng-template>

                        <ng-template pTemplate="file" let-file>
                            <div class="flex items-center flex-wrap p-3">
                                <div class="flex items-center gap-3">
                                    <i class="pi pi-file-excel text-green-600" style="font-size: 2rem"></i>
                                    <span class="font-semibold">{{ file.name }}</span>
                                    <p-badge [value]="getFileSizeInMB(file.size)" severity="secondary"></p-badge>
                                </div>
                            </div>
                        </ng-template>
                    </p-fileUpload>
                </div>
            }

            @if (postventaDetalleStore.entitiesPreview().length > 0 && !postventaDetalleStore.isLoadingCreate()) {
                <div class="mt-6 border-1 border-dashed border-primary p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold">Previsualización de Datos</h3>
                        <div class="flex gap-1">
                            <p-button label="Volver a importar" [outlined]="true" icon="pi pi-arrow-left"
                                      [loading]="postventaDetalleStore.isLoadingCreate()"
                                      (onClick)="handleImportAgain()"></p-button>
                            <p-button label="Guardar Datos Importados" icon="pi pi-save"
                                      [loading]="postventaDetalleStore.isLoadingCreate()"
                                      (onClick)="handleSubmitDetail()"></p-button>
                        </div>
                    </div>

                    <p-table
                        [value]="postventaDetalleStore.entitiesPreview()"
                        [paginator]="true"
                        [rows]="10"
                        [rowsPerPageOptions]="[10, 25, 50, 100]"
                        [totalRecords]="postventaDetalleStore.entitiesPreview().length"
                        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} filas"
                        [showCurrentPageReport]="true"
                        class="p-datatable-striped"
                    >
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="min-width: 8rem">FECHA CARGA</th>
                                <th style="min-width: 8rem">TIPO LIQUIDACION</th>
                                <th style="min-width: 8rem">COD. SAP</th>
                                <th style="min-width: 8rem">CONTRATISTA</th>
                                <th style="min-width: 8rem">DEPARTAMENTO</th>
                                <th style="min-width: 8rem">SOT</th>
                                <th style="min-width: 8rem">FECHA INSTALACION</th>
                                <th style="min-width: 8rem">CODIGO ACTIVIDAD</th>
                                <th style="min-width: 40rem">DESCRIPCION ACTIVIDAD</th>
                                <th style="min-width: 8rem">CANTIDAD</th>
                                <th style="min-width: 8rem">COSTO</th>
                                <th style="min-width: 8rem">TOTAL</th>
                                <th style="min-width: 8rem">TIPO DE TRABAJO</th>
                                <th style="min-width: 12rem">SERVICIO</th>
                                <th style="min-width: 12rem">ORDEN DE COMPRA</th>
                                <th style="min-width: 8rem">MES DE PAGO</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-detalle>
                            <tr>
                                <td>{{ detalle.fechaCarga | shortDate }}</td>
                                <td>{{ detalle.tipoLiquidacion }}</td>
                                <td>{{ detalle.codigoSAP }}</td>
                                <td>{{ detalle.contratista }}</td>
                                <td>{{ detalle.departamento }}</td>
                                <td>{{ detalle.codigoSOT }}</td>
                                <td>{{ detalle.fechaInstalacion | shortDate }}</td>
                                <td>{{ detalle.codigoActividad }}</td>
                                <td>{{ detalle.actividadDescripcion }}</td>
                                <td>{{ detalle.cantidad }}</td>
                                <td>{{ detalle.costo | formatCurrency }}</td>
                                <td>{{ detalle.total | formatCurrency }}</td>
                                <td>{{ detalle.tipoTrabajo }}</td>
                                <td>{{ detalle.servicio }}</td>
                                <td>{{ detalle.ordenCompra }}</td>
                                <td>{{ detalle.mesPago }}</td>
                            </tr>
                        </ng-template>

                        <ng-template #emptymessage>
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="flex flex-col items-center gap-2">
                                        <i class="pi pi-info-circle" style="font-size: 1.5rem"></i>
                                        <span>No se encontraron datos para mostrar</span>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            }
        } @else {
            <div class="flex flex-col items-center">
                <i class="pi pi-exclamation-triangle text-red-800" style="font-size: 2.5rem"></i>
                <p class="text-red-800">No se pudo cargar el detalle.</p>
            </div>
        }
    </div>
</p-card>

<div class="flex flex-col flex-1 h-full">
    <p-card class="mt-4 flex-1 relative overflow-hidden">
        <p-table
            #dataTable
            dataKey="id"
            [value]="postventaDetalleStore.entities()"
            [selection]="selectedItems()"
            (selectionChange)="selectedItems.set($event)"
            [rows]="pageSize()"
            [paginator]="true"
            [tableStyle]="{ 'min-width': '75rem' }"
            [rowsPerPageOptions]="[10, 20, 30]"
            [showCurrentPageReport]="true"
            [rowHover]="true"
            [scrollable]="true"
            [loading]="this.postventaDetalleStore.isLoadingDetailData()"
            [totalRecords]="totalRecords()"
            [lazy]="true"
            (onLazyLoad)="onPageChange($event)"
            scrollHeight="h-[calc(100dvh-20rem)]"
            currentPageReportTemplate="Visualizar {first} a {last} de {totalRecords} registros"
        >
            <ng-template #caption>
                <div class="flex items-center justify-between">
                    <div class="flex flex-row gap-2">
                        <p-iconfield>
                            <p-inputicon class="pi pi-search" />
                            <input pInputText type="text" [(ngModel)]="searchModel"
                                   (ngModelChange)="onSearchInputChange()"
                                   pTooltip="Buscar por Código SAP o Código SOT o Orden de Compra" tooltipPosition="top"
                                   placeholder="Buscar por Código SAP o Código SOT o Orden de Compra" />
                        </p-iconfield>
                        <p-button icon="pi pi-filter-slash" [outlined]="true" [disabled]="!searchModel"
                                  (click)="onClearFilters()" />
                        <p-button severity="danger" [label]="deleteButtonLabel()"
                                  icon="pi pi-trash" [disabled]="!selectedItems().length"
                                  (onClick)="deleteSelectedItems()" />
                        <p-button label="Eliminar todo" severity="danger" [outlined]="true" icon="pi pi-trash"
                                  [disabled]="!postventaDetalleStore.entities().length" (onClick)="deleteAllItems()" />
                    </div>

                    <div class="flex flex-row gap-2">
                        @if (this.postventaDetalleStore.entities() && postventaDetalleStore.entities().length > 0) {
                            <div class="card flex justify-between gap-3">
                                <p-button
                                    label="Descargar Reporte"
                                    severity="success"
                                    icon="pi pi-file-excel"
                                    [disabled]="postventaDetalleStore.isExporting() || postventaDetalleStore.entities().length <= 0"
                                    [loading]="postventaDetalleStore.isExporting()"
                                    (click)="exportDataTable()"
                                />
                            </div>
                        }
                    </div>
                </div>
            </ng-template>

            <ng-template #header>
                <tr>
                    <th style="width: 3rem" pFrozenColumn>
                        <p-tableHeaderCheckbox />
                    </th>
                    <th pSortableColumn="fechaCarga" style="min-width: 8rem">
                        Fecha Carga
                        <p-sortIcon field="fechaCarga" />
                    </th>

                    <th pSortableColumn="tipoLiquidacion" style="min-width: 8rem">
                        Tipo Liquidación
                        <p-sortIcon field="tipoLiquidacion" />
                    </th>

                    <th pSortableColumn="codigoSAP" style="min-width: 8rem">
                        Cod. SAP
                        <p-sortIcon field="codigoSAP" />
                    </th>

                    <th pSortableColumn="contratista" style="min-width: 8rem">
                        Contratista
                        <p-sortIcon field="contratista" />
                    </th>

                    <th pSortableColumn="departamento" style="min-width: 8rem">
                        Departamento
                        <p-sortIcon field="departamento" />
                    </th>

                    <th pSortableColumn="codigoSOT" style="min-width: 8rem">
                        SOT
                        <p-sortIcon field="codigoSOT" />
                    </th>

                    <th pSortableColumn="fechaInstalacion" style="min-width: 8rem">
                        Fecha Instalación
                        <p-sortIcon field="fechaInstalacion" />
                    </th>

                    <th pSortableColumn="codigoActividad" style="min-width: 8rem">
                        Código Actividad
                        <p-sortIcon field="codigoActividad" />
                    </th>

                    <th pSortableColumn="actividadDescripcion" style="min-width: 40rem">
                        Descripción Actividad
                        <p-sortIcon field="actividadDescripcion" />
                    </th>

                    <th pSortableColumn="cantidad" style="min-width: 8rem">
                        Cantidad
                        <p-sortIcon field="cantidad" />
                    </th>

                    <th pSortableColumn="costo" style="min-width: 8rem">
                        Costo
                        <p-sortIcon field="costo" />
                    </th>

                    <th pSortableColumn="total" style="min-width: 8rem">
                        Total
                        <p-sortIcon field="total" />
                    </th>

                    <th pSortableColumn="tipoTrabajo" style="min-width: 8rem">
                        Tipo de Trabajo
                        <p-sortIcon field="tipoTrabajo" />
                    </th>

                    <th pSortableColumn="servicio" style="min-width: 12rem">
                        Servicio
                        <p-sortIcon field="servicio" />
                    </th>

                    <th pSortableColumn="ordenCompra" style="min-width: 12rem">
                        Orden de Compra
                        <p-sortIcon field="ordenCompra" />
                    </th>

                    <th pSortableColumn="mesPago" style="min-width: 8rem">
                        Mes de Pago
                        <p-sortIcon field="mesPago" />
                    </th>
                </tr>
            </ng-template>

            <ng-template #body let-detalle let-rowIndex="rowIndex">
                <tr>
                    <td style="width: 3rem" pFrozenColumn>
                        <p-tableCheckbox [value]="detalle" />
                    </td>
                    <td>{{ detalle.fechaCarga | shortDate }}</td>
                    <td>{{ detalle.tipoLiquidacion }}</td>
                    <td>{{ detalle.codigoSAP }}</td>
                    <td>{{ detalle.contratista }}</td>
                    <td>{{ detalle.departamento }}</td>
                    <td>{{ detalle.codigoSOT }}</td>
                    <td>{{ detalle.fechaInstalacion | shortDate }}</td>
                    <td>{{ detalle.codigoActividad }}</td>
                    <td>{{ detalle.actividadDescripcion }}</td>
                    <td>{{ detalle.cantidad }}</td>
                    <td>{{ detalle.costo | formatCurrency }}</td>
                    <td>{{ detalle.total | formatCurrency }}</td>
                    <td>{{ detalle.tipoTrabajo }}</td>
                    <td>{{ detalle.servicio }}</td>
                    <td>{{ detalle.ordenCompra }}</td>
                    <td>{{ detalle.mesPago }}</td>
                </tr>
            </ng-template>

            <ng-template #emptymessage>
                <tr>
                    <td colspan="13" class="text-center py-4">
                        <div class="flex flex-col items-center gap-2">
                            <i class="pi pi-info-circle" style="font-size: 1.5rem"></i>
                            <span>No se encontraron datos para mostrar</span>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>
</div>
